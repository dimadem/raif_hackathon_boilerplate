name: Release

on:
  push:
    tags:
      - 'v*.*.*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Build & Deploy on Target Server
  # ===========================================================================
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Build and Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          password: ${{ secrets.PROD_SSH_PASSWORD }}
          envs: REPO,VERSION
          command_timeout: 25m
          script: |
            set -e

            APP_DIR=~/app

            # Clone or update repo
            if [ ! -d "$APP_DIR" ]; then
              echo "Cloning repository..."
              git clone "https://github.com/$REPO.git" "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "Fetching latest changes..."
            git fetch --all --tags --prune
            git reset --hard
            git checkout -f "$VERSION"

            echo "Building Docker image..."
            docker build -t app:"$VERSION" -t app:latest .

            echo "Restarting container..."
            docker stop app || true
            docker rm app || true
            docker volume create model_cache || true
            docker run -d \
              --name app \
              --restart unless-stopped \
              -p 8000:8000 \
              -v model_cache:/app/model_cache \
              app:"$VERSION"

            # Cleanup old images
            docker image prune -f

            # Health check
            echo "Running health check..."
            sleep 5
            if ! docker inspect app --format='{{.State.Running}}' | grep -q true; then
              echo "Container failed to start"
              docker logs app
              exit 1
            fi

            echo "Deployment successful!"
        env:
          REPO: ${{ github.repository }}
          VERSION: ${{ github.ref_name }}

      - name: Deployment summary
        run: |
          echo "##Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Docs:** ${{ secrets.APP_URL }}:8000/docs" >> $GITHUB_STEP_SUMMARY
